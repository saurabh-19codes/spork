// SlideInCommentsWidget.spec.tsx
import React from 'react';
import { render, screen, fireEvent, act } from '@testing-library/react';
import SlideInCommentsWidget from './SlideInCommentsWidget';

// Mock hooks and dependencies
jest.mock('@americanexpress/one-insight-toolkit', () => ({
  SlideInComments: jest.fn(({ onCloseBtnClick, onSubmitBtnClick, onReplyBtnClick }) => (
    <div>
      <button onClick={onCloseBtnClick}>close</button>
      <button onClick={() => onSubmitBtnClick('new comment')}>submit</button>
      <button onClick={() => onReplyBtnClick('reply text', { commentId: 123 })}>reply</button>
    </div>
  )),
  objToQueryParams: jest.fn(() => 'mockQuery'),
}));

const mockUseApp = jest.fn();
jest.mock('../hooks/useAuthData', () => ({
  useApp: () => mockUseApp(),
}));

const mockCloseComments = jest.fn();
const mockUseComments = jest.fn();
jest.mock('../contexts/CommentsContext', () => ({
  useComments: () => mockUseComments(),
}));

describe('SlideInCommentsWidget', () => {
  let getCommentsMock: jest.Mock;
  let postCommentMock: jest.Mock;
  let postReplyMock: jest.Mock;

  beforeEach(() => {
    jest.clearAllMocks();

    getCommentsMock = jest.fn();
    postCommentMock = jest.fn();
    postReplyMock = jest.fn();

    // Default mocks for hooks
    mockUseComments.mockReturnValue({
      isOpen: true,
      closeComments: mockCloseComments,
      payload: { id: 1 },
    });

    mockUseApp
      // useApp for getComments
      .mockReturnValueOnce({
        isLoading: false,
        data: { body: [] },
        run: getCommentsMock,
      })
      // useApp for postComment
      .mockReturnValueOnce({
        isLoading: false,
        run: postCommentMock,
      })
      // useApp for postReplyComment
      .mockReturnValueOnce({
        isLoading: false,
        run: postReplyMock,
      });
  });

  it('renders and closes comments on button click', () => {
    render(<SlideInCommentsWidget />);

    fireEvent.click(screen.getByText('close'));
    expect(mockCloseComments).toHaveBeenCalled();
  });

  it('calls setComment and triggers postComment useEffect', () => {
    jest.useFakeTimers();
    render(<SlideInCommentsWidget />);
    fireEvent.click(screen.getByText('submit'));
    act(() => {
      jest.runAllTimers();
    });
    expect(postCommentMock).toHaveBeenCalled();
  });

  it('calls setReply and triggers postReply useEffect', () => {
    jest.useFakeTimers();
    render(<SlideInCommentsWidget />);
    fireEvent.click(screen.getByText('reply'));
    act(() => {
      jest.runAllTimers();
    });
    expect(postReplyMock).toHaveBeenCalled();
  });

  it('fetches comments when isOpen and payload change', () => {
    render(<SlideInCommentsWidget />);
    expect(getCommentsMock).toHaveBeenCalled();
  });

  it('renders empty messages array when data.body is not an array', () => {
    mockUseApp
      .mockReturnValueOnce({
        isLoading: false,
        data: { body: {} }, // Not an array
        run: getCommentsMock,
      })
      .mockReturnValueOnce({
        isLoading: false,
        run: postCommentMock,
      })
      .mockReturnValueOnce({
        isLoading: false,
        run: postReplyMock,
      });

    render(<SlideInCommentsWidget />);
    expect(getCommentsMock).toHaveBeenCalled();
  });
});
